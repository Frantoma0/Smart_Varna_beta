<!DOCTYPE html>
<html lang="bg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application</title>
    <!-- –í—ä–Ω—à–Ω–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libheif-js@1.17.1/libheif.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        /* --- –û–°–ù–û–í–ù–ò –°–¢–ò–õ–û–í–ï (–° –ü–û–î–û–ë–†–ï–ù–ò–Ø) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        #chat-container {
            width: 100%;
            max-width: 600px;
            height: 90vh;
            max-height: 800px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 10;
        }

        #chat-log {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* UI –ü–û–î–û–ë–†–ï–ù–ò–ï: –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –ø–æ—è–≤—è–≤–∞–Ω–µ –Ω–∞ —Å—ä–æ–±—â–µ–Ω–∏—è—Ç–∞ */
        .chat-message {
            padding: 10px 15px;
            border-radius: 20px;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
            transform: scale(0.95);
            opacity: 0;
            animation: message-enter 0.3s ease-out forwards;
        }

        @keyframes message-enter {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .bot-message {
            background-color: #f1f0f0;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .user-message {
            background-color: #007bff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
            padding: 5px;
        }

        .user-message img {
            max-width: 100%;
            border-radius: 15px;
            display: block;
        }

        .processing-message-content {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .loading-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9eaab6;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        /* UI –ü–û–î–û–ë–†–ï–ù–ò–ï: –ü–æ-–¥–æ–±—ä—Ä —Ñ–æ–∫—É—Å –∏ –≤–∏–∑–∏—è –Ω–∞ –ø–æ–ª–µ—Ç–æ –∑–∞ –≤—ä–≤–µ–∂–¥–∞–Ω–µ */
        #input-area {
            border-top: 1px solid #e0e0e0;
            padding: 12px 15px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: box-shadow 0.2s;
        }

        #chat-input {
            flex-grow: 1;
            border: none;
            background: transparent;
            padding: 10px 5px;
            font-size: 16px;
        }

        #chat-input:focus {
            outline: none;
        }

        #chat-input:focus-within {
            box-shadow: 0 -2px 10px rgba(0, 123, 255, 0.1);
        }

        /* UI –ü–û–î–û–ë–†–ï–ù–ò–ï: –ú–∏–∫—Ä–æ-–∏–Ω—Ç–µ—Ä–∞–∫—Ü–∏–∏ –ø—Ä–∏ –±—É—Ç–æ–Ω–∏—Ç–µ */
        .input-button {
            border: none;
            background: none;
            padding: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            transition: transform 0.2s, color 0.2s;
        }

        .input-button:hover {
            transform: scale(1.1);
            color: #007bff;
        }

        .input-button img,
        .input-button svg {
            width: 24px;
            height: 24px;
        }

        #send-btn {
            color: white;
            background-color: #007bff;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
        }

        #send-btn:hover {
            color: white;
            background-color: #0056b3;
        }

        #file-input {
            display: none;
        }

        /* UX –ü–û–î–û–ë–†–ï–ù–ò–ï: –°—Ç–∏–ª –∑–∞ "–ë—ä—Ä–∑–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏" */
        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-reply-btn {
            background-color: transparent;
            border: 1px solid #007bff;
            color: #007bff;
            padding: 8px 14px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }

        .quick-reply-btn:hover {
            background-color: #007bff;
            color: white;
        }

        /* UX –ü–û–î–û–ë–†–ï–ù–ò–ï: –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∞ */
        @keyframes pulse-highlight {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.4);
            }

            70% {
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0);
            }
        }

        .highlight-action {
            animation: pulse-highlight 1.5s infinite;
            border-radius: 50%;
        }

        /* UI –ü–û–î–û–ë–†–ï–ù–ò–ï: –ü–æ-–¥–æ–±—Ä–∏ –±—É—Ç–æ–Ω–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è */
        .location-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 8px;
            font-weight: bold;
            border: 1px solid #007bff;
            transition: transform 0.2s, background-color 0.2s;
        }

        .location-button:hover {
            transform: translateY(-2px);
        }

        .location-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .skip-button {
            background-color: #6c757d;
            border-color: #6c757d;
            margin-left: 5px;
        }

        .skip-button:hover {
            background-color: #5a6268;
        }

        .confirm-button {
            background-color: #28a745;
            border-color: #28a745;
            margin-right: 10px;
        }

        .confirm-button:hover {
            background-color: #218838;
        }

        .cancel-button {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .cancel-button:hover {
            background-color: #c82333;
        }

        .edit-button {
            background-color: #ffc107;
            border-color: #ffc107;
            color: #212529;
            margin-left: 5px;
        }

        .edit-button:hover {
            background-color: #e0a800;
        }

        .media-container {
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            line-height: 0;
            max-width: 300px;
        }

        .uploaded-photo {
            transition: opacity 0.5s ease-in-out;
            width: 100%;
        }

        .uploaded-photo.fade-out {
            opacity: 0;
        }

        .map-inline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1;
            border-radius: 15px;
        }

        .map-inline.fade-in {
            opacity: 1;
        }

        .map-inline.fade-out {
            opacity: 0;
        }

        #mic-btn.listening {
            color: #dc3545;
            animation: pulse-mic 1.5s infinite;
        }

        @keyframes pulse-mic {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        /* --- –°–¢–ò–õ–û–í–ï –ó–ê –ê–ù–ò–ú–ê–¶–ò–Ø –ù–ê –ò–ó–ü–†–ê–©–ê–ù–ï (–±–µ–∑ –ø—Ä–æ–º—è–Ω–∞) --- */
        .signal-card-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .signal-card-overlay.visible {
            opacity: 1;
        }

        .card-flipper {
            width: 90%;
            max-width: 480px;
            height: 80%;
            max-height: 640px;
            perspective: 1500px;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
        }

        .card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .card-face-front {
            /* –õ–∏—Ü–µ–≤–∞—Ç–∞ —Å—Ç—Ä–∞–Ω–∞ */
        }

        .card-face-back {
            transform: rotateY(180deg);
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .card-description {
            padding: 15px;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .card-media-container {
            flex-grow: 1;
            position: relative;
            background-color: #e0e0e0;
        }

        .card-photo,
        .card-map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s ease-in-out;
        }

        .card-photo.fade-out {
            opacity: 0;
        }

        .card-map {
            opacity: 0;
        }

        .card-map.fade-in {
            opacity: 1;
        }

        .card-institution-icon {
            width: 120px;
            height: 120px;
        }

        .card-institution-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #333;
            text-align: center;
            padding: 0 20px;
        }
    </style>
</head>

<body>

    <div id="chat-container">
        <div id="chat-log"></div>
        <div id="input-area">
            <label for="file-input" id="file-input-label" class="input-button">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"
                        clip-rule="evenodd"></path>
                </svg>
            </label>
            <button id="mic-btn" class="input-button">
                <img src="images/mic.png" alt="–ú–∏–∫—Ä–æ—Ñ–æ–Ω">
            </button>
            <input type="text" id="chat-input" placeholder="–ù–∞–ø–∏—à–µ—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ...">
            <button id="send-btn" class="input-button">
                <svg fill="currentColor" viewBox="0 0 20 20">
                    <path
                        d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z">
                    </path>
                </svg>
            </button>
            <input type="file" id="file-input" accept="image/*,.heic,.heif">
        </div>
    </div>

    <script>
        // ===================================================================
        // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø - –ü–û–ü–™–õ–ù–ï–¢–ï –í–°–ò–ß–ö–ò –ö–õ–Æ–ß–û–í–ï –¢–£–ö
        // ===================================================================
        // Remove import of keys.js and any secret variables
        // Remove: import { OPENAI_API_KEY, OPENCAGE_API_KEY, SUPABASE_URL, SUPABASE_ANON_KEY } from './keys.js';
        // Remove: const supabaseClient = supabase.createClient(...);
        // For all OpenAI, OpenCage, and Supabase operations, replace with fetches to backend endpoints
        // Example for OpenAI:
        //   fetch('/api/analyze-image', { ... })
        // Example for OpenCage:
        //   fetch(`/api/get-address?lat=${lat}&lng=${lng}`)
        // Example for Supabase:
        //   fetch('/api/submit-signal', { method: 'POST', body: JSON.stringify(signalData), headers: { 'Content-Type': 'application/json' } })
        //   fetch(`/api/check-status?tracking_code=${trackingCode}`)
        // All logic and UI remain, but all sensitive operations are now backend calls.

        const dataCategoriesJSON = `{"–î–∞–Ω—ä—Ü–∏ –∏ —Ç–∞–∫—Å–∏": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –æ–±—â–∏–Ω—Å–∫–∞ —Å–æ–±—Å—Ç–≤–µ–Ω–æ—Å—Ç": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–ó–æ–Ω–∏—Ä–∞–Ω–µ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–ì—Ä–∞–¥—Å–∫–æ –ø–ª–∞–Ω–∏—Ä–∞–Ω–µ": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ –ø–∞—Ä–∫–æ–≤–µ": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–£–ª–∏—á–Ω–∏ –ø–µ–π–∫–∏ –∏ –æ–±–∑–∞–≤–µ–∂–¥–∞–Ω–µ": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–ü—Ä–æ–±–ª–µ–º–∏ —Å —á–∏—Å—Ç–æ—Ç–∞—Ç–∞": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∏ –ø–∞—Ä–∫–∏—Ä–∞–Ω–µ": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–î—ä—Ä–≤–µ—Ç–∞ –∏ —Ä–∞—Å—Ç–∏—Ç–µ–ª–Ω–æ—Å—Ç": { "institution": "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞" }, "–ú–µ—Å—Ç–Ω–∏ –¥–∞–Ω—ä—Ü–∏": { "institution": "–†–∞–π–æ–Ω –û–¥–µ—Å–æ—Å" }, "–†–∞–π–æ–Ω–Ω–∏ –ø—ä—Ç–∏—â–∞": { "institution": "–†–∞–π–æ–Ω –û–¥–µ—Å–æ—Å" }, "–ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ —Ç—Ä–æ—Ç–æ–∞—Ä–∏": { "institution": "–†–∞–π–æ–Ω –û–¥–µ—Å–æ—Å" }, "–£–ª–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏": { "institution": "–†–∞–π–æ–Ω –û–¥–µ—Å–æ—Å" }, "–ö–æ–º—É–Ω–∞–ª–Ω–∏ —É—Å–ª—É–≥–∏ –≤ –∫–≤–∞—Ä—Ç–∞–ª–∞": { "institution": "–†–∞–π–æ–Ω –û–¥–µ—Å–æ—Å" }, "–ú–µ—Å—Ç–Ω–∏ –¥–∞–Ω—ä—Ü–∏ (–ü—Ä–∏–º–æ—Ä—Å–∫–∏)": { "institution": "–†–∞–π–æ–Ω –ü—Ä–∏–º–æ—Ä—Å–∫–∏" }, "–†–∞–π–æ–Ω–Ω–∏ –ø—ä—Ç–∏—â–∞ (–ü—Ä–∏–º–æ—Ä—Å–∫–∏)": { "institution": "–†–∞–π–æ–Ω –ü—Ä–∏–º–æ—Ä—Å–∫–∏" }, "–ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ —Ç—Ä–æ—Ç–æ–∞—Ä–∏ (–ü—Ä–∏–º–æ—Ä—Å–∫–∏)": { "institution": "–†–∞–π–æ–Ω –ü—Ä–∏–º–æ—Ä—Å–∫–∏" }, "–£–ª–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ (–ü—Ä–∏–º–æ—Ä—Å–∫–∏)": { "institution": "–†–∞–π–æ–Ω –ü—Ä–∏–º–æ—Ä—Å–∫–∏" }, "–ö–æ–º—É–Ω–∞–ª–Ω–∏ —É—Å–ª—É–≥–∏ –≤ –∫–≤–∞—Ä—Ç–∞–ª–∞ (–ü—Ä–∏–º–æ—Ä—Å–∫–∏)": { "institution": "–†–∞–π–æ–Ω –ü—Ä–∏–º–æ—Ä—Å–∫–∏" }, "–ú–µ—Å—Ç–Ω–∏ –¥–∞–Ω—ä—Ü–∏ (–ú–ª–∞–¥–æ—Å—Ç)": { "institution": "–†–∞–π–æ–Ω –ú–ª–∞–¥–æ—Å—Ç" }, "–†–∞–π–æ–Ω–Ω–∏ –ø—ä—Ç–∏—â–∞ (–ú–ª–∞–¥–æ—Å—Ç)": { "institution": "–†–∞–π–æ–Ω –ú–ª–∞–¥–æ—Å—Ç" }, "–ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ —Ç—Ä–æ—Ç–æ–∞—Ä–∏ (–ú–ª–∞–¥–æ—Å—Ç)": { "institution": "–†–∞–π–æ–Ω –ú–ª–∞–¥–æ—Å—Ç" }, "–£–ª–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ (–ú–ª–∞–¥–æ—Å—Ç)": { "institution": "–†–∞–π–æ–Ω –ú–ª–∞–¥–æ—Å—Ç" }, "–ö–æ–º—É–Ω–∞–ª–Ω–∏ —É—Å–ª—É–≥–∏ –≤ –∫–≤–∞—Ä—Ç–∞–ª–∞ (–ú–ª–∞–¥–æ—Å—Ç)": { "institution": "–†–∞–π–æ–Ω –ú–ª–∞–¥–æ—Å—Ç" }, "–ú–µ—Å—Ç–Ω–∏ –¥–∞–Ω—ä—Ü–∏ (–ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ)": { "institution": "–†–∞–π–æ–Ω –ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ" }, "–†–∞–π–æ–Ω–Ω–∏ –ø—ä—Ç–∏—â–∞ (–ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ)": { "institution": "–†–∞–π–æ–Ω –ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ" }, "–ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ —Ç—Ä–æ—Ç–æ–∞—Ä–∏ (–ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ)": { "institution": "–†–∞–π–æ–Ω –ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ" }, "–£–ª–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ (–ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ)": { "institution": "–†–∞–π–æ–Ω –ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ" }, "–ö–æ–º—É–Ω–∞–ª–Ω–∏ —É—Å–ª—É–≥–∏ –≤ –∫–≤–∞—Ä—Ç–∞–ª–∞ (–ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ)": { "institution": "–†–∞–π–æ–Ω –ê—Å–ø–∞—Ä—É—Ö–æ–≤–æ" }, "–ú–µ—Å—Ç–Ω–∏ –¥–∞–Ω—ä—Ü–∏ (–í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫)": { "institution": "–†–∞–π–æ–Ω –í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫" }, "–†–∞–π–æ–Ω–Ω–∏ –ø—ä—Ç–∏—â–∞ (–í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫)": { "institution": "–†–∞–π–æ–Ω –í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫" }, "–ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ —Ç—Ä–æ—Ç–æ–∞—Ä–∏ (–í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫)": { "institution": "–†–∞–π–æ–Ω –í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫" }, "–£–ª–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏ –∏ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∏ (–í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫)": { "institution": "–†–∞–π–æ–Ω –í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫" }, "–ö–æ–º—É–Ω–∞–ª–Ω–∏ —É—Å–ª—É–≥–∏ –≤ –∫–≤–∞—Ä—Ç–∞–ª–∞ (–í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫)": { "institution": "–†–∞–π–æ–Ω –í–ª–∞–¥–∏—Å–ª–∞–≤ –í–∞—Ä–Ω–µ–Ω—á–∏–∫" }, "–ù–∞—Ä—É—à–µ–Ω–∏—è –ø—Ä–∏ –ø–∞—Ä–∫–∏—Ä–∞–Ω–µ (–ú–í–†)": { "institution": "–û–±–ª–∞—Å—Ç–Ω–∞ –¥–∏—Ä–µ–∫—Ü–∏—è –Ω–∞ –ú–í–† - –í–∞—Ä–Ω–∞" }, "–û–ø–∞—Å–Ω–æ—Å—Ç–Ω–æ —à–æ—Ñ–∏—Ä–∞–Ω–µ": { "institution": "–û–±–ª–∞—Å—Ç–Ω–∞ –¥–∏—Ä–µ–∫—Ü–∏—è –Ω–∞ –ú–í–† - –í–∞—Ä–Ω–∞" }, "–ü—Ä–µ–≤–∏—à–µ–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç": { "institution": "–û–±–ª–∞—Å—Ç–Ω–∞ –¥–∏—Ä–µ–∫—Ü–∏—è –Ω–∞ –ú–í–† - –í–∞—Ä–Ω–∞" }, "–ü—ä—Ç–Ω–∏ –ø—Ä–æ–∏–∑—à–µ—Å—Ç–≤–∏—è": { "institution": "–û–±–ª–∞—Å—Ç–Ω–∞ –¥–∏—Ä–µ–∫—Ü–∏—è –Ω–∞ –ú–í–† - –í–∞—Ä–Ω–∞" }, "–®—É–º–Ω–∏ –ø—Ä–µ–≤–æ–∑–Ω–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞": { "institution": "–û–±–ª–∞—Å—Ç–Ω–∞ –¥–∏—Ä–µ–∫—Ü–∏—è –Ω–∞ –ú–í–† - –í–∞—Ä–Ω–∞" }, "–ù–µ–ª–µ–≥–∞–ª–Ω–∏ —Å—ä–±–∏—Ä–∞–Ω–∏—è": { "institution": "–û–±–ª–∞—Å—Ç–Ω–∞ –¥–∏—Ä–µ–∫—Ü–∏—è –Ω–∞ –ú–í–† - –í–∞—Ä–Ω–∞" }, "–ì—Ä–∞—Ñ–∏—Ç–∏ –∏ –≤–∞–Ω–¥–∞–ª–∏–∑—ä–º": { "institution": "–û–±–ª–∞—Å—Ç–Ω–∞ –¥–∏—Ä–µ–∫—Ü–∏—è –Ω–∞ –ú–í–† - –í–∞—Ä–Ω–∞" }, "–û–±—â–µ—Å—Ç–≤–µ–Ω —Ä–µ–¥": { "institution": "–û–±–ª–∞—Å—Ç–Ω–∞ –¥–∏—Ä–µ–∫—Ü–∏—è –Ω–∞ –ú–í–† - –í–∞—Ä–Ω–∞" }, "–ü—Ä–µ—Å—Ç—ä–ø–ª–µ–Ω–∏—è": { "institution": "–†–∞–π–æ–Ω–Ω–∞ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞ - –í–∞—Ä–Ω–∞" }, "–ö–æ—Ä—É–ø—Ü–∏—è": { "institution": "–†–∞–π–æ–Ω–Ω–∞ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞ - –í–∞—Ä–Ω–∞" }, "–ò–º–æ—Ç–Ω–∏ –ø—Ä–µ—Å—Ç—ä–ø–ª–µ–Ω–∏—è": { "institution": "–†–∞–π–æ–Ω–Ω–∞ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞ - –í–∞—Ä–Ω–∞" }, "–ù–∞—Ä—É—à–µ–Ω–∏—è –Ω–∞ –∑–∞–∫–æ–Ω–∞": { "institution": "–†–∞–π–æ–Ω–Ω–∞ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä–∞ - –í–∞—Ä–Ω–∞" }, "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∏ —Å–ø–æ—Ä–æ–≤–µ": { "institution": "–û–∫—Ä—ä–∂–µ–Ω —Å—ä–¥ - –í–∞—Ä–Ω–∞" }, "–¢—ä—Ä–≥–æ–≤—Å–∫–∏ –¥–µ–ª–∞": { "institution": "–û–∫—Ä—ä–∂–µ–Ω —Å—ä–¥ - –í–∞—Ä–Ω–∞" }, "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏ —Å–ø–æ—Ä–æ–≤–µ": { "institution": "–û–∫—Ä—ä–∂–µ–Ω —Å—ä–¥ - –í–∞—Ä–Ω–∞" }, "–ù–∞–∫–∞–∑–∞—Ç–µ–ª–Ω–∏ –¥–µ–ª–∞": { "institution": "–†–∞–π–æ–Ω–µ–Ω —Å—ä–¥ - –í–∞—Ä–Ω–∞" }, "–°–µ–º–µ–π–Ω–∏ —Å–ø–æ—Ä–æ–≤–µ": { "institution": "–†–∞–π–æ–Ω–µ–Ω —Å—ä–¥ - –í–∞—Ä–Ω–∞" }, "–ú–∞–ª–∫–∏ —Ç—ä—Ä–≥–æ–≤—Å–∫–∏ —Å–ø–æ—Ä–æ–≤–µ": { "institution": "–†–∞–π–æ–Ω–µ–Ω —Å—ä–¥ - –í–∞—Ä–Ω–∞" }, "–î–∞–Ω—ä—á–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏": { "institution": "–¢–î –Ω–∞ –ù–ê–ü –í–∞—Ä–Ω–∞" }, "–¢–∞–∫—Å–∏ –∏ –º–∏—Ç–∞": { "institution": "–¢–î –Ω–∞ –ù–ê–ü –í–∞—Ä–Ω–∞" }, "–§–∏–Ω–∞–Ω—Å–æ–≤–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è": { "institution": "–¢–î –Ω–∞ –ù–ê–ü –í–∞—Ä–Ω–∞" }, "–ü–µ–Ω—Å–∏–æ–Ω–Ω–∏ –≤—ä–ø—Ä–æ—Å–∏": { "institution": "–ù–û–ò - –í–∞—Ä–Ω–∞" }, "–û—Å–∏–≥—É—Ä–æ–≤–∫–∏": { "institution": "–ù–û–ò - –í–∞—Ä–Ω–∞" }, "–ò–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç": { "institution": "–ù–û–ò - –í–∞—Ä–Ω–∞" }, "–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∏ –ø—Ä–∞–≤–∞": { "institution": "–ö–ó–ü - –í–∞—Ä–Ω–∞" }, "–ù–µ—á–µ—Å—Ç–Ω–∏ —Ç—ä—Ä–≥–æ–≤—Å–∫–∏ –ø—Ä–∞–∫—Ç–∏–∫–∏": { "institution": "–ö–ó–ü - –í–∞—Ä–Ω–∞" }, "–ö–∞—á–µ—Å—Ç–≤–æ –Ω–∞ —Å—Ç–æ–∫–∏ –∏ —É—Å–ª—É–≥–∏": { "institution": "–ö–ó–ü - –í–∞—Ä–Ω–∞" }, "–¢—Ä—É–¥–æ–≤–∏ —Å–ø–æ—Ä–æ–≤–µ": { "institution": "–ò–Ω—Å–ø–µ–∫—Ü–∏—è –ø–æ —Ç—Ä—É–¥–∞" }, "–ù–µ—Ä–µ–¥–æ–≤–Ω–∏ –∑–∞–ø–ª–∞—Ç–∏": { "institution": "–ò–Ω—Å–ø–µ–∫—Ü–∏—è –ø–æ —Ç—Ä—É–¥–∞" }, "–£—Å–ª–æ–≤–∏—è –Ω–∞ —Ç—Ä—É–¥": { "institution": "–ò–Ω—Å–ø–µ–∫—Ü–∏—è –ø–æ —Ç—Ä—É–¥–∞" }, "–ó–¥—Ä–∞–≤–Ω–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏": { "institution": "–†–ó–ò - –í–∞—Ä–Ω–∞" }, "–•–∏–≥–∏–µ–Ω–∞": { "institution": "–†–ó–ò - –í–∞—Ä–Ω–∞" }, "–ï–ø–∏–¥–µ–º–∏–æ–ª–æ–≥–∏—á–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª": { "institution": "–†–ó–ò - –í–∞—Ä–Ω–∞" }, "–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç –Ω–∞ —Ö—Ä–∞–Ω–∏—Ç–µ": { "institution": "–†–ó–ò - –í–∞—Ä–Ω–∞" }, "–ó–∞–º—ä—Ä—Å—è–≤–∞–Ω–µ –Ω–∞ –≤—ä–∑–¥—É—Ö–∞": { "institution": "–†–ò–û–°–í - –í–∞—Ä–Ω–∞" }, "–ù–µ–∑–∞–∫–æ–Ω–Ω–æ –∏–∑—Ö–≤—ä—Ä–ª—è–Ω–µ –Ω–∞ –æ—Ç–ø–∞–¥—ä—Ü–∏": { "institution": "–†–ò–û–°–í - –í–∞—Ä–Ω–∞" }, "–ó–∞–º—ä—Ä—Å—è–≤–∞–Ω–µ –Ω–∞ –≤–æ–¥–∏—Ç–µ": { "institution": "–†–ò–û–°–í - –í–∞—Ä–Ω–∞" }, "–®—É–º–æ–≤–æ –∑–∞–º—ä—Ä—Å—è–≤–∞–Ω–µ": { "institution": "–†–ò–û–°–í - –í–∞—Ä–Ω–∞" }, "–í–æ–¥–æ—Å–Ω–∞–±–¥—è–≤–∞–Ω–µ": { "institution": "–í–∏–ö –í–∞—Ä–Ω–∞ –û–û–î" }, "–ö–∞–Ω–∞–ª–∏–∑–∞—Ü–∏–æ–Ω–Ω–∏ –ø—Ä–æ–±–ª–µ–º–∏": { "institution": "–í–∏–ö –í–∞—Ä–Ω–∞ –û–û–î" }, "–¢–µ—á–æ–≤–µ –æ—Ç —Ç—Ä—ä–±–∏": { "institution": "–í–∏–ö –í–∞—Ä–Ω–∞ –û–û–î" }, "–ó–∞–ø—É—à–≤–∞–Ω–µ –Ω–∞ –∫–∞–Ω–∞–ª–∏": { "institution": "–í–∏–ö –í–∞—Ä–Ω–∞ –û–û–î" }, "–û–±—â–µ—Å—Ç–≤–µ–Ω —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç": { "institution": "–ì—Ä–∞–¥—Å–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ï–ê–î" }, "–ê–≤—Ç–æ–±—É—Å–Ω–∏ —Å–ø–∏—Ä–∫–∏": { "institution": "–ì—Ä–∞–¥—Å–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ï–ê–î" }, "–†–∞–∑–ø–∏—Å–∞–Ω–∏—è": { "institution": "–ì—Ä–∞–¥—Å–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ï–ê–î" }, "–ö–∞—á–µ—Å—Ç–≤–æ –Ω–∞ —É—Å–ª—É–≥–∏—Ç–µ": { "institution": "–ì—Ä–∞–¥—Å–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –ï–ê–î" }, "–°–≤–µ—Ç–æ—Ñ–∞—Ä–∏": { "institution": "–û–ü –¢–ê–°–†–£–î" }, "–ü—ä—Ç–Ω–∞ –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞": { "institution": "–û–ü –¢–ê–°–†–£–î" }, "–£–ª–∏—á–Ω–∏ –∑–Ω–∞—Ü–∏": { "institution": "–û–ü –¢–ê–°–†–£–î" }, "–†–µ–≥—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ —Ç—Ä–∞—Ñ–∏–∫–∞": { "institution": "–û–ü –¢–ê–°–†–£–î" }, "–ü—Ä–∏—Ä–æ–¥–Ω–∏ –±–µ–¥—Å—Ç–≤–∏—è": { "institution": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ –∑–∞—â–∏—Ç–∞ - –û–±–ª–∞—Å—Ç–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" }, "–ê–≤–∞—Ä–∏–π–Ω–∏ —Å–∏—Ç—É–∞—Ü–∏–∏": { "institution": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ –∑–∞—â–∏—Ç–∞ - –û–±–ª–∞—Å—Ç–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" }, "–ï–≤–∞–∫—É–∞—Ü–∏–∏": { "institution": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ –∑–∞—â–∏—Ç–∞ - –û–±–ª–∞—Å—Ç–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ" }, "–ü–æ–∂–∞—Ä–∏ (–ü—ä—Ä–≤–∞ –†–°–ü–ë–ó–ù)": { "institution": "–ü—ä—Ä–≤–∞ –†–°–ü–ë–ó–ù ‚Äì –í–∞—Ä–Ω–∞" }, "–ê–≤–∞—Ä–∏–π–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏ (–ü—ä—Ä–≤–∞ –†–°–ü–ë–ó–ù)": { "institution": "–ü—ä—Ä–≤–∞ –†–°–ü–ë–ó–ù ‚Äì –í–∞—Ä–Ω–∞" }, "–ü–æ–∂–∞—Ä–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç (–ü—ä—Ä–≤–∞ –†–°–ü–ë–ó–ù)": { "institution": "–ü—ä—Ä–≤–∞ –†–°–ü–ë–ó–ù ‚Äì –í–∞—Ä–Ω–∞" }, "–ü–æ–∂–∞—Ä–∏ (–í—Ç–æ—Ä–∞ –†–°–ü–ë–ó–ù)": { "institution": "–í—Ç–æ—Ä–∞ –†–°–ü–ë–ó–ù ‚Äì –í–∞—Ä–Ω–∞" }, "–ê–≤–∞—Ä–∏–π–Ω–∏ —Å–∏–≥–Ω–∞–ª–∏ (–í—Ç–æ—Ä–∞ –†–°–ü–ë–ó–ù)": { "institution": "–í—Ç–æ—Ä–∞ –†–°–ü–ë–ó–ù ‚Äì –í–∞—Ä–Ω–∞" }, "–ü–æ–∂–∞—Ä–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç (–í—Ç–æ—Ä–∞ –†–°–ü–ë–ó–ù)": { "institution": "–í—Ç–æ—Ä–∞ –†–°–ü–ë–ó–ù ‚Äì –í–∞—Ä–Ω–∞" }, "–î—É–ø–∫–∏ –ø–æ –ø—ä—Ç—è": { "institution": "–ê–≥–µ–Ω—Ü–∏—è –ü—ä—Ç–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞" }, "–ü–æ–≤—Ä–µ–¥–µ–Ω–∏ –ø—ä—Ç–Ω–∏ –Ω–∞—Å—Ç–∏–ª–∫–∏": { "institution": "–ê–≥–µ–Ω—Ü–∏—è –ü—ä—Ç–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞" }, "–ö–∞—á–µ—Å—Ç–≤–æ –Ω–∞ –ø—ä—Ç–∏—â–∞—Ç–∞": { "institution": "–ê–≥–µ–Ω—Ü–∏—è –ü—ä—Ç–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞" }, "–ü—ä—Ç–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç": { "institution": "–ê–≥–µ–Ω—Ü–∏—è –ü—ä—Ç–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞" } }`;
        const OPENAI_VISION_SYSTEM_PROMPT = `–†–û–õ–Ø –ò –ö–û–ù–¢–ï–ö–°–¢: –¢–∏ —Å–∏ –≤–∏—Å–æ–∫–æ—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω AI –∞—Å–∏—Å—Ç–µ–Ω—Ç –∑–∞ –û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞. –¢–≤–æ—è—Ç–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–∞ –∑–∞–¥–∞—á–∞ –µ –¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –ø–æ–¥–∞–¥–µ–Ω–∏ –æ—Ç –≥—Ä–∞–∂–¥–∞–Ω–∏, –∏ –¥–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞—à –ï–î–ò–ù-–ï–î–ò–ù–°–¢–í–ï–ù, –Ω–∞–π-—Å—ä—â–µ—Å—Ç–≤–µ–Ω –∫–æ–º—É–Ω–∞–ª–µ–Ω –ø—Ä–æ–±–ª–µ–º. –¢–≤–æ—è—Ç –æ—Ç–≥–æ–≤–æ—Ä —â–µ –±—ä–¥–µ –∏–∑–ø–æ–ª–∑–≤–∞–Ω –∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–ø—ä–ª–≤–∞–Ω–µ –Ω–∞ –ø–æ–ª–µ "–æ–ø–∏—Å–∞–Ω–∏–µ" –≤ —Å–∏—Å—Ç–µ–º–∞ –∑–∞ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏ —Å–∏–≥–Ω–∞–ª–∏, –∑–∞—Ç–æ–≤–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –±—ä–¥–µ –º–∞–∫—Å–∏–º–∞–ª–Ω–æ —Ç–æ—á–µ–Ω, –∫—Ä–∞—Ç—ä–∫ –∏ –Ω–∞–ø—ä–ª–Ω–æ –ª–∏—à–µ–Ω –æ—Ç –¥–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–µ–Ω —Ç–µ–∫—Å—Ç. –ü–†–û–¶–ï–° –ù–ê –ê–ù–ê–õ–ò–ó (–°–ª–µ–¥–≤–∞–π —Ç–µ–∑–∏ —Å—Ç—ä–ø–∫–∏ –≤ –º–∏—Å–ª–∏—Ç–µ —Å–∏): –ü—ä—Ä–≤–∏—á–Ω–∞ –∏–Ω—Å–ø–µ–∫—Ü–∏—è: –û–≥–ª–µ–¥–∞–π —Ü—è–ª–æ—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∑–∞ –¥–∞ —Ä–∞–∑–±–µ—Ä–µ—à –æ–±—â–∞—Ç–∞ —Å—Ü–µ–Ω–∞ (—É–ª–∏—Ü–∞, –ø–∞—Ä–∫, —Ç—Ä–æ—Ç–æ–∞—Ä, –º–µ–∂–¥—É–±–ª–æ–∫–æ–≤–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ). –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–∞ –Ω–µ—Ä–µ–¥–Ω–æ—Å—Ç–∏: –ê–∫—Ç–∏–≤–Ω–æ —Ç—ä—Ä—Å–∏ –ø—Ä–æ–±–ª–µ–º–∏, –ø–æ–ø–∞–¥–∞—â–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏—Ç–µ –ø–æ-–¥–æ–ª—É. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è: –ê–∫–æ –∏–º–∞ –ø–æ–≤–µ—á–µ –æ—Ç –µ–¥–Ω–∞ –Ω–µ—Ä–µ–¥–Ω–æ—Å—Ç, –æ–ø—Ä–µ–¥–µ–ª–∏ –∫–æ—è –µ –Ω–∞–π-–∑–Ω–∞—á–∏–º–∞—Ç–∞ –∏–ª–∏ –Ω–∞–π-—Å–ø–µ—à–Ω–∞—Ç–∞. –§–æ–∫—É—Å–∏—Ä–∞–π —Å–µ —Å–∞–º–æ –≤—ä—Ä—Ö—É –Ω–µ—è. –§–æ—Ä–º—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∞: –°—ä–∑–¥–∞–π —Ñ–∏–Ω–∞–ª–Ω–∏—è –æ—Ç–≥–æ–≤–æ—Ä, –∫–∞—Ç–æ —Å—Ç—Ä–∏–∫—Ç–Ω–æ —Å–ø–∞–∑–≤–∞—à –ø—Ä–∞–≤–∏–ª–∞—Ç–∞ –∑–∞ —Ñ–æ—Ä–º–∞—Ç. –ö–ê–¢–ï–ì–û–†–ò–ò –ù–ê –ü–†–û–ë–õ–ï–ú–ò –ó–ê –ê–ù–ê–õ–ò–ó: –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –î—É–ø–∫–∏ –ø–æ –ø–ª–∞—Ç–Ω–æ—Ç–æ, —Å—á—É–ø–µ–Ω–∏ –ø–ª–æ—á–∫–∏, –æ—Ç–≤–æ—Ä–µ–Ω–∏ –∏–ª–∏ –ø–æ–≤—Ä–µ–¥–µ–Ω–∏ —à–∞—Ö—Ç–∏, –ø–∞–¥–Ω–∞–ª–∏/—Å—á—É–ø–µ–Ω–∏ –ø—ä—Ç–Ω–∏ –∑–Ω–∞—Ü–∏, –ø–æ–≤—Ä–µ–¥–µ–Ω–∏ –∫–æ–ª—á–µ—Ç–∞. –ß–∏—Å—Ç–æ—Ç–∞ –∏ –æ—Ç–ø–∞–¥—ä—Ü–∏: –ü—Ä–µ–ª–∏–≤–∞—â–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏, –±–æ–∫–ª—É–∫ –∏–∑–≤—ä–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏—Ç–µ, –Ω–µ–∑–∞–∫–æ–Ω–Ω–∏ —Å–º–µ—Ç–∏—â–∞, –Ω–µ–ø–æ—á–∏—Å—Ç–µ–Ω–∏ –ø–ª–æ—â–∏. –ü–æ–¥–¥—Ä—ä–∂–∫–∞ –Ω–∞ –∑–µ–ª–µ–Ω–∏ –ø–ª–æ—â–∏: –ù–µ–æ–∫–æ—Å–µ–Ω–∞ —Ç—Ä–µ–≤–∞, –ø–∞–¥–Ω–∞–ª–∏ –∏–ª–∏ –æ–ø–∞—Å–Ω–æ –Ω–∞–¥–≤–∏—Å–Ω–∞–ª–∏ –∫–ª–æ–Ω–∏/–¥—ä—Ä–≤–µ—Ç–∞, –∏–∑–±—É—è–ª–∞ —Ä–∞—Å—Ç–∏—Ç–µ–ª–Ω–æ—Å—Ç, –∫–æ—è—Ç–æ –ø—Ä–µ—á–∏ –Ω–∞ –ø—Ä–µ–º–∏–Ω–∞–≤–∞–Ω–µ—Ç–æ. –ì—Ä–∞–¥—Å–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä –∏ –≤–∞–Ω–¥–∞–ª–∏–∑—ä–º: –°—á—É–ø–µ–Ω–∏ –ø–µ–π–∫–∏, –ø–æ–≤—Ä–µ–¥–µ–Ω–∏ —Å–ø–∏—Ä–∫–∏ –Ω–∞ –≥—Ä–∞–¥—Å–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –≥—Ä–∞—Ñ–∏—Ç–∏ –≤—ä—Ä—Ö—É –æ–±—â–µ—Å—Ç–≤–µ–Ω–∏ —Å–≥—Ä–∞–¥–∏ –∏ —Å—ä–æ—Ä—ä–∂–µ–Ω–∏—è. –ù–µ–ø—Ä–∞–≤–∏–ª–Ω–æ –ø–∞—Ä–∫–∏—Ä–∞–Ω–µ: –ê–≤—Ç–æ–º–æ–±–∏–ª–∏, –ø–∞—Ä–∫–∏—Ä–∞–Ω–∏ –Ω–∞ —Ç—Ä–æ—Ç–æ–∞—Ä–∏, –ø–µ—à–µ—Ö–æ–¥–Ω–∏ –ø—ä—Ç–µ–∫–∏, –∑–µ–ª–µ–Ω–∏ –ø–ª–æ—â–∏ –∏–ª–∏ —Ä–∞–º–ø–∏ –∑–∞ –∏–Ω–≤–∞–ª–∏–¥–∏. –ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–ò –ü–†–ê–í–ò–õ–ê –ó–ê –§–û–†–ú–ê–¢–ê –ù–ê –û–¢–ì–û–í–û–†–ê: –ï–î–ò–ù–°–¢–í–ï–ù–û –û–ü–ò–°–ê–ù–ò–ï: –í—ä—Ä–Ω–∏ —Å–∞–º–æ –∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–≤–µ–Ω–æ —Ç–µ–∫—Å—Ç–æ–≤–æ—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞. –î–™–õ–ñ–ò–ù–ê: –û—Ç–≥–æ–≤–æ—Ä—ä—Ç —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –º–µ–∂–¥—É 3 –∏ 7 –¥—É–º–∏. –°–™–î–™–†–ñ–ê–ù–ò–ï: –û–ø–∏—Å–∞–Ω–∏–µ—Ç–æ —Ç—Ä—è–±–≤–∞ —è—Å–Ω–æ –¥–∞ –ø–æ—Å–æ—á–≤–∞ –ö–ê–ö–™–í –µ –ø—Ä–æ–±–ª–µ–º—ä—Ç –∏ –ö–™–î–ï —Å–µ –Ω–∞–º–∏—Ä–∞ —Å–ø—Ä—è–º–æ –¥—Ä—É–≥ –æ–±–µ–∫—Ç. –ë–ï–ó –î–û–ü–™–õ–ù–ò–¢–ï–õ–ï–ù –¢–ï–ö–°–¢: –û—Ç–≥–æ–≤–æ—Ä—ä—Ç –ù–ï —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞ –æ–±—Ä—ä—â–µ–Ω–∏—è, –æ–±—è—Å–Ω–µ–Ω–∏—è, –∫–æ–º–µ–Ω—Ç–∞—Ä–∏ –∏–ª–∏ –∫–∞–∫—ä–≤—Ç–æ –∏ –¥–∞ –µ —Ç–µ–∫—Å—Ç –∏–∑–≤—ä–Ω –æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ. –ë–ï–ó –ü–†–ï–ü–ò–ù–ê–¢–ï–õ–ù–ò –ó–ù–ê–¶–ò: –ù–µ –∏–∑–ø–æ–ª–∑–≤–∞–π –ø—Ä–µ–ø–∏–Ω–∞—Ç–µ–ª–Ω–∏ –∑–Ω–∞—Ü–∏ –≤ –∫—Ä–∞—è –Ω–∞ –∏–∑—Ä–µ—á–µ–Ω–∏–µ—Ç–æ. –°–ü–†–ê–í–Ø–ù–ï –°–™–° –°–ü–ï–¶–ò–§–ò–ß–ù–ò –°–õ–£–ß–ê–ò: –ê–∫–æ –Ω—è–º–∞ —è–≤–µ–Ω –ø—Ä–æ–±–ª–µ–º: –í—ä—Ä–Ω–∏ —Ç–æ—á–Ω–∏—è —Ç–µ–∫—Å—Ç: –ù–µ –µ —É—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞ –Ω–µ—Ä–µ–¥–Ω–æ—Å—Ç, –º–æ–ª—è –æ–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞. –ê–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ—Ç–æ –µ –Ω–µ—è—Å–Ω–æ –∏–ª–∏ —Ç—ä–º–Ω–æ: –í—ä—Ä–Ω–∏ —Ç–æ—á–Ω–∏—è —Ç–µ–∫—Å—Ç: –ù–µ—è—Å–Ω–∞ —Å–Ω–∏–º–∫–∞, –º–æ–ª—è –æ–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞. –ü–†–ò–ú–ï–†–ò: –î–û–ë–†–ò –ü–†–ò–ú–ï–†–ò (–¢–æ–≤–∞ –µ, –∫–æ–µ—Ç–æ –æ—á–∞–∫–≤–∞–º): –î—É–ø–∫–∞ –ø–æ –ø—ä—Ç–Ω–æ—Ç–æ –ø–ª–∞—Ç–Ω–æ. –ù–µ–æ–∫–æ—Å–µ–Ω–∞ —Ç—Ä–µ–≤–∞ –≤ –º–µ–∂–¥—É–±–ª–æ–∫–æ–≤–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ. –ü—Ä–µ–ª–∏–≤–∞—â –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞ —Å–º–µ—Ç. –°—á—É–ø–µ–Ω–∞ –ø–µ–π–∫–∞ –≤ –≥—Ä–∞–¥–∏–Ω–∫–∞. –û–ø–∞—Å–µ–Ω –∫–ª–æ–Ω –Ω–∞–¥–≤–∏—Å–Ω–∞–ª –Ω–∞–¥ —Ç—Ä–æ—Ç–æ–∞—Ä. –ù–µ–ø—Ä–∞–≤–∏–ª–Ω–æ –ø–∞—Ä–∫–∏—Ä–∞–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª –Ω–∞ —Ç—Ä–æ—Ç–æ–∞—Ä. –ü–∞–¥–Ω–∞–ª –ø—ä—Ç–µ–Ω –∑–Ω–∞–∫ –Ω–∞ –∫—Ä—ä—Å—Ç–æ–≤–∏—â–µ. –í–∏—Å–æ–∫–∞ —Ä–∞—Å—Ç–∏—Ç–µ–ª–Ω–æ—Å—Ç –ø—Ä–µ—á–∏ –Ω–∞ –≤–∏–¥–∏–º–æ—Å—Ç—Ç–∞. –õ–û–®–ò –ü–†–ò–ú–ï–†–ò (–¢–æ–≤–∞ –ù–ï —Ç—Ä—è–±–≤–∞ –¥–∞ –ø—Ä–∞–≤–∏—à): –ì—Ä–µ—à–Ω–æ: –ü—Ä–æ–±–ª–µ–º: –ù–µ–æ–∫–æ—Å–µ–Ω–∞ —Ç—Ä–µ–≤–∞. (–°—ä–¥—ä—Ä–∂–∞ "–ü—Ä–æ–±–ª–µ–º:" –∏ —Ç–æ—á–∫–∞). –ì—Ä–µ—à–Ω–æ: –ù–∞ —Å–Ω–∏–º–∫–∞—Ç–∞ —Å–µ –≤–∏–∂–¥–∞ –≤–∏—Å–æ–∫–∞ —Ç—Ä–µ–≤–∞. (–ò–∑–ª–∏—à–Ω–æ –æ–ø–∏—Å–∞—Ç–µ–ª–Ω–æ –∏–∑—Ä–µ—á–µ–Ω–∏–µ). –ì—Ä–µ—à–Ω–æ: –¢—Ä–µ–≤–∞ (–¢–≤—ä—Ä–¥–µ –∫—Ä–∞—Ç–∫–æ, –ª–∏–ø—Å–≤–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç)`;
        const OPENAI_INSTITUTION_PROMPT = `–†–û–õ–Ø –ò –ö–û–ù–¢–ï–ö–°–¢: –¢–∏ —Å–∏ AI —Ä—É—Ç–µ—Ä –∑–∞ —Ä–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª–∏ –≤ –û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞. –¢–≤–æ—è—Ç–∞ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–∞ –∑–∞–¥–∞—á–∞ –µ –¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—à –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º –∏ –¥–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—à –∫–æ—è –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è –µ –æ—Ç–≥–æ–≤–æ—Ä–Ω–∞ –∑–∞ –Ω–µ–≥–æ. –ò–ù–°–¢–†–£–ö–¶–ò–ò: 1. –©–µ –ø–æ–ª—É—á–∏—à –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º. 2. –©–µ –ø–æ–ª—É—á–∏—à JSON –æ–±–µ–∫—Ç, –≤ –∫–æ–π—Ç–æ –∫–ª—é—á–æ–≤–µ—Ç–µ —Å–∞ —Ç–∏–ø–æ–≤–µ –ø—Ä–æ–±–ª–µ–º–∏, –∞ —Å—Ç–æ–π–Ω–æ—Å—Ç–∏—Ç–µ —Å—ä–¥—ä—Ä–∂–∞—Ç –∏–º–µ—Ç–æ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–Ω–∞—Ç–∞ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è. 3. –°—ä–ø–æ—Å—Ç–∞–≤–∏ –æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –Ω–∞–π-–ø–æ–¥—Ö–æ–¥—è—â–∏—è —Ç–∏–ø –ø—Ä–æ–±–ª–µ–º –æ—Ç JSON-–∞. 4. –í—ä—Ä–Ω–∏ –°–ê–ú–û –ò –ï–î–ò–ù–°–¢–í–ï–ù–û –∏–º–µ—Ç–æ –Ω–∞ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è—Ç–∞ ("institution") –∫–∞—Ç–æ —á–∏—Å—Ç —Ç–µ–∫—Å—Ç. –ó–ê–î–™–õ–ñ–ò–¢–ï–õ–ù–ò –ü–†–ê–í–ò–õ–ê –ó–ê –§–û–†–ú–ê–¢–ê –ù–ê –û–¢–ì–û–í–û–†–ê: - –ë–ï–ó –î–û–ü–™–õ–ù–ò–¢–ï–õ–ï–ù –¢–ï–ö–°–¢: –û—Ç–≥–æ–≤–æ—Ä—ä—Ç –ù–ï —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞ –æ–±—Ä—ä—â–µ–Ω–∏—è, –∫–æ–º–µ–Ω—Ç–∞—Ä–∏, JSON —Ñ–æ—Ä–º–∞—Ç–∏—Ä–∞–Ω–µ –∏–ª–∏ –∫–∞–∫—ä–≤—Ç–æ –∏ –¥–∞ –µ —Ç–µ–∫—Å—Ç –∏–∑–≤—ä–Ω –∏–º–µ—Ç–æ –Ω–∞ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è—Ç–∞. - –ê–∫–æ –Ω–µ –º–æ–∂–µ—à –¥–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—à –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è, –≤—ä—Ä–Ω–∏ "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞". –ü–†–ò–ú–ï–†–ò: - –ü—Ä–∏ –ø–æ–¥–∞–¥–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ "–î—É–ø–∫–∞ –ø–æ –ø—ä—Ç—è", —Ç—Ä—è–±–≤–∞ –¥–∞ –≤—ä—Ä–Ω–µ—à "–ê–≥–µ–Ω—Ü–∏—è –ü—ä—Ç–Ω–∞ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞". - –ü—Ä–∏ –ø–æ–¥–∞–¥–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ "–ü—Ä–µ–ª–∏–≤–∞—â –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞ —Å–º–µ—Ç", —Ç—Ä—è–±–≤–∞ –¥–∞ –≤—ä—Ä–Ω–µ—à "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞". - –ü—Ä–∏ –ø–æ–¥–∞–¥–µ–Ω–æ –æ–ø–∏—Å–∞–Ω–∏–µ "–ù–µ–ø—Ä–∞–≤–∏–ª–Ω–æ –ø–∞—Ä–∫–∏—Ä–∞–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª –Ω–∞ —Ç—Ä–æ—Ç–æ–∞—Ä", —Ç—Ä—è–±–≤–∞ –¥–∞ –≤—ä—Ä–Ω–µ—à "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞". JSON –î–ê–ù–ù–ò –° –ò–ù–°–¢–ò–¢–£–¶–ò–ò: ${dataCategoriesJSON}`;
        const OPENAI_INTENT_PROMPT = `–¢–∏ —Å–∏ AI –∑–∞ –∫–ª–∞—Å–∏—Ñ–∏—Ü–∏—Ä–∞–Ω–µ –Ω–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏—è. –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π –ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è –∏ –æ–ø—Ä–µ–¥–µ–ª–∏ –Ω–µ–≥–æ–≤–æ—Ç–æ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ. –í—ä–∑–º–æ–∂–Ω–∏—Ç–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è —Å–∞: 'submit_signal', 'check_status', 'general_chat'. –ê–∫–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –æ–ø–∏—Å–≤–∞ –ø—Ä–æ–±–ª–µ–º (–Ω–∞–ø—Ä. "–∏–º–∞ –¥—É–ø–∫–∞", "–±–æ–∫–ª—É–∫—ä—Ç –µ —Ä–∞–∑—Ö–≤—ä—Ä–ª—è–Ω"), –Ω–∞–º–µ—Ä–µ–Ω–∏–µ—Ç–æ –µ 'submit_signal'. –ê–∫–æ –ø–∏—Ç–∞ –∑–∞ —Å—Ç–∞—Ç—É—Å –∏–ª–∏ –¥–∞–≤–∞ –∫–æ–¥ –∑–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ (–Ω–∞–ø—Ä. "–ø—Ä–æ–≤–µ—Ä–∏ SV-12345", "–∫–∞–∫—ä–≤ –µ —Å—Ç–∞—Ç—É—Å—ä—Ç"), –Ω–∞–º–µ—Ä–µ–Ω–∏–µ—Ç–æ –µ 'check_status'. –í—ä–≤ –≤—Å–∏—á–∫–∏ –æ—Å—Ç–∞–Ω–∞–ª–∏ —Å–ª—É—á–∞–∏ –µ 'general_chat'. –ò–∑–≤–ª–µ—á–∏ –∏ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞—â–∏—è –∫–æ–¥, –∞–∫–æ –∏–º–∞ —Ç–∞–∫—ä–≤. –í—ä—Ä–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –°–ê–ú–û –∫–∞—Ç–æ JSON –æ–±–µ–∫—Ç. –ü—Ä–∏–º–µ—Ä: {"intent": "check_status", "tracking_code": "SV-12345"}.`;
        const OPENAI_EXTRACTION_PROMPT = `–¢–∏ —Å–∏ AI –∑–∞ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è. –¢–≤–æ—è—Ç–∞ –∑–∞–¥–∞—á–∞ –µ –¥–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä–∞—à –ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä –∏ –¥–∞ –∏–∑–≤–ª–µ—á–µ—à –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º –∏/–∏–ª–∏ –∞–¥—Ä–µ—Å. –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –ø–æ–¥–∞–≤–∞ —Å–∏–≥–Ω–∞–ª –∑–∞ –Ω–µ—Ä–µ–¥–Ω–æ—Å—Ç –≤ –≥—Ä–∞–¥ –í–∞—Ä–Ω–∞. –í—ä—Ä–Ω–∏ —Ä–µ–∑—É–ª—Ç–∞—Ç–∞ –°–ê–ú–û –∫–∞—Ç–æ JSON –æ–±–µ–∫—Ç —Å –∫–ª—é—á–æ–≤–µ "description" –∏ "address". –ê–∫–æ –¥–∞–¥–µ–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ª–∏–ø—Å–≤–∞, —Å—Ç–æ–π–Ω–æ—Å—Ç—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ null. –û–ø–∏—Å–∞–Ω–∏–µ—Ç–æ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –∫—Ä–∞—Ç–∫–æ –∏ —è—Å–Ω–æ. –ü—Ä–∏–º–µ—Ä: User: "–∏–º–∞ –ø–∞–¥–Ω–∞–ª–æ –¥—ä—Ä–≤–æ –Ω–∞ –±—É–ª–µ–≤–∞—Ä–¥ –°–ª–∏–≤–Ω–∏—Ü–∞ 23" -> {"description": "–ø–∞–¥–Ω–∞–ª–æ –¥—ä—Ä–≤–æ", "address": "–±—É–ª–µ–≤–∞—Ä–¥ –°–ª–∏–≤–Ω–∏—Ü–∞ 23, –í–∞—Ä–Ω–∞"}. User: "–±–æ–∫–ª—É—Ü–∏—Ç–µ –ø—Ä–µ–¥ –Ω–∞—Å –Ω–µ —Å–∞ –∏–∑—Ö–≤—ä—Ä–ª–µ–Ω–∏" -> {"description": "–Ω–µ–∏–∑—Ö–≤—ä—Ä–ª–µ–Ω–∏ –±–æ–∫–ª—É—Ü–∏", "address": null}.`;
        const OPENAI_CONVERSATION_SYSTEM_PROMPT = `–¢–∏ —Å–∏ "–°–º–∞—Ä—Ç–∏", –ø—Ä–∏—è—Ç–µ–ª—Å–∫–∏ –∏ –ª–µ–∫–æ –Ω–µ—Ñ–æ—Ä–º–∞–ª–µ–Ω –¥–∏–≥–∏—Ç–∞–ª–µ–Ω –∞—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞ SmartVarna. –¢–≤–æ—è—Ç–∞ –≥–ª–∞–≤–Ω–∞ –∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–∞ —Ü–µ–ª –µ –¥–∞ –Ω–∞–∫–∞—Ä–∞—à –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è –¥–∞ –∑–∞–ø–æ—á–Ω–µ –ø—Ä–æ—Ü–µ—Å–∞ –ø–æ –ø–æ–¥–∞–≤–∞–Ω–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª. –ù–ê–ß–ò–ù–ò –ó–ê –ü–û–î–ê–í–ê–ù–ï –ù–ê –°–ò–ì–ù–ê–õ: 1. –ß—Ä–µ–∑ –ø—Ä–∏–∫–∞—á–∞–Ω–µ –Ω–∞ —Å–Ω–∏–º–∫–∞. 2. –ß—Ä–µ–∑ –∏–∑–ø–∏—Å–≤–∞–Ω–µ –Ω–∞ —Ç–æ—á–Ω–∞—Ç–∞ —Ñ—Ä–∞–∑–∞ "—Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞". –¢–í–û–Ø–¢–ê –õ–ò–ß–ù–û–°–¢ –ò –ü–û–í–ï–î–ï–ù–ò–ï: - –ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, —è—Å–Ω–æ –∏ –¥–∏—Ä–µ–∫—Ç–Ω–æ (1-2 –∏–∑—Ä–µ—á–µ–Ω–∏—è). –ë—ä–¥–∏ —É—Å–ª—É–∂–ª–∏–≤ –∏ –ø–æ–∑–∏—Ç–∏–≤–µ–Ω. –ò–∑–ø–æ–ª–∑–≤–∞–π –µ–º–æ–¥–∂–∏—Ç–∞. üòä - –ù–µ —Å–µ –ø—Ä–µ–¥—Å—Ç–∞–≤—è–π –æ—Ç–Ω–æ–≤–æ. –†–∞–∑–≥–æ–≤–æ—Ä—ä—Ç –∏–º–∞ –ø–∞–º–µ—Ç. - **–ö–õ–Æ–ß–û–í–û –ü–†–ê–í–ò–õ–û:** –ö–æ–≥–∞—Ç–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç —Ç–µ –ø–∏—Ç–∞ –ö–ê–ö –¥–∞ –ø–æ–¥–∞–¥–µ —Å–∏–≥–Ω–∞–ª, –∏–ª–∏ –¥–∞–ª–∏ –º–æ–∂–µ –¥–∞ –ø–æ–¥–∞–¥–µ —Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞, –∏–ª–∏ –¥–∏—Ä–µ–∫—Ç–Ω–æ –æ–ø–∏—Å–≤–∞ –ø—Ä–æ–±–ª–µ–º, —Ç–≤–æ—è—Ç–∞ –∑–∞–¥–∞—á–∞ –µ –¥–∞ –≥–æ –Ω–∞—Å–æ—á–∏—à –∫—ä–º –µ–¥–∏–Ω –æ—Ç –¥–≤–∞—Ç–∞ –æ—Ñ–∏—Ü–∏–∞–ª–Ω–∏ –Ω–∞—á–∏–Ω–∞. –ü—Ä–∏–º–µ—Ä–∏: User: –ú–æ–≥–∞ –ª–∏ –¥–∞ –ø–æ–¥–∞–º —Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞? Smarty: –†–∞–∑–±–∏—Ä–∞ —Å–µ! –ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–µ—Ç–µ '—Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞' –≤ —á–∞—Ç–∞, –∑–∞ –¥–∞ –∑–∞–ø–æ—á–Ω–µ–º. üëç User: –ò–º–∞ –ø–∞–¥–Ω–∞–ª–æ –¥—ä—Ä–≤–æ –¥–æ –º–µ–Ω. Smarty: –†–∞–∑–±–∏—Ä–∞–º, –Ω–µ–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–º–µ —Å–∏–≥–Ω–∞–ª–∞. –ú–æ–ª—è, –ø—Ä–∏–∫–∞—á–µ—Ç–µ —Å–Ω–∏–º–∫–∞ –∏–ª–∏ –Ω–∞–ø–∏—à–µ—Ç–µ '—Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞', –∑–∞ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏–º. User: –ö–∞–∫ —Å–∏? Smarty: –°—É–ø–µ—Ä —Å—ä–º, –±–ª–∞–≥–æ–¥–∞—Ä—è! –ì–æ—Ç–æ–≤ —Å—ä–º –¥–∞ –ø–æ–º–æ–≥–Ω–∞. –ò–º–∞—Ç–µ –ª–∏ —Å–∏–≥–Ω–∞–ª –∑–∞ –ø–æ–¥–∞–≤–∞–Ω–µ? –ú–æ–∂–µ –¥–∞ –ø—Ä–∏–∫–∞—á–∏—Ç–µ —Å–Ω–∏–º–∫–∞ –∏–ª–∏ –¥–∞ –Ω–∞–ø–∏—à–µ—Ç–µ '—Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞'.`;

        // ===================================================================
        // –û–°–ù–û–í–ù–ê –õ–û–ì–ò–ö–ê –ù–ê –ß–ê–¢–ë–û–¢–ê
        // ===================================================================

        const chatLog = document.getElementById('chat-log');
        const fileInput = document.getElementById('file-input');
        const fileInputLabel = document.getElementById('file-input-label');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');

        let conversationState = 'idle';
        let tempSignalData = {};
        let conversationHistory = [];
        let recognition;

        // UX –ü–û–î–û–ë–†–ï–ù–ò–ï: –ü—Ä–æ–º–µ–Ω–µ–Ω–æ –ø—ä—Ä–≤–æ–Ω–∞—á–∞–ª–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ —Å –±—ä—Ä–∑–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏
        document.addEventListener('DOMContentLoaded', () => {
            const initialMessage = `–ó–¥—Ä–∞–≤–µ–π—Ç–µ! –ê–∑ —Å—ä–º –°–º–∞—Ä—Ç–∏. üòä –ö–∞–∫ –º–æ–≥–∞ –¥–∞ –≤–∏ –ø–æ–º–æ–≥–Ω–∞ –¥–Ω–µ—Å?
    <div class="quick-replies">
        <button class="quick-reply-btn" data-action="start_signal_photo">üì∑ –ü–æ–¥–∞–π —Å–∏–≥–Ω–∞–ª —Å—ä—Å —Å–Ω–∏–º–∫–∞</button>
        <button class="quick-reply-btn" data-action="start_signal_no_photo">‚úçÔ∏è –ü–æ–¥–∞–π —Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞</button>
        <button class="quick-reply-btn" data-action="check_status">#Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä–∏ —Å—Ç–∞—Ç—É—Å</button>
    </div>`;
            addBotMessage(initialMessage, true);
            setupSpeechRecognition();
        });

        fileInput.addEventListener('change', handleFileSelect);
        sendBtn.addEventListener('click', handleTextInput);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleTextInput(); });
        chatLog.addEventListener('click', handleChatButtonClick); // –¢–æ–∑–∏ handler –≤–µ—á–µ —â–µ —É–ø—Ä–∞–≤–ª—è–≤–∞ –∏ –±—ä—Ä–∑–∏—Ç–µ –æ—Ç–≥–æ–≤–æ—Ä–∏
        micBtn.addEventListener('click', toggleSpeechRecognition);

        function addMessage(content, type, isHtml = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', type);
            if (isHtml) messageDiv.innerHTML = content;
            else messageDiv.textContent = content;
            chatLog.appendChild(messageDiv);
            chatLog.scrollTop = chatLog.scrollHeight;
            return messageDiv;
        }
        function addBotMessage(text, isHtml = false) { return addMessage(text, 'bot-message', isHtml); }
        function addUserMessage(content, isImage = false) {
            if (isImage) {
                const msgElement = addMessage('', 'user-message', true);
                msgElement.innerHTML = `<div class="media-container"><img src="${content}" alt="–ü—Ä–∏–∫–∞—á–µ–Ω–∞ —Å–Ω–∏–º–∫–∞" class="uploaded-photo"></div>`;
                return msgElement.querySelector('.media-container');
            }
            return addMessage(content, 'user-message');
        }
        function updateProcessingMessage(text) {
            let processingMsg = document.getElementById('processing-message');
            if (!processingMsg) {
                const messageDiv = document.createElement('div');
                messageDiv.id = 'processing-message';
                messageDiv.classList.add('chat-message', 'bot-message');
                messageDiv.innerHTML = `<div class="processing-message-content">
            <span class="message-text">${text}</span>
            <div class="loading-indicator"><span></span><span></span><span></span></div>
        </div>`;
                chatLog.appendChild(messageDiv);
            } else {
                processingMsg.querySelector('.message-text').textContent = text;
            }
            chatLog.scrollTop = chatLog.scrollHeight;
        }
        function removeProcessingMessage() { document.getElementById('processing-message')?.remove(); }
        function toggleInput(enabled, placeholder = '–ù–∞–ø–∏—à–µ—Ç–µ —Å—ä–æ–±—â–µ–Ω–∏–µ...') {
            chatInput.disabled = !enabled;
            sendBtn.disabled = !enabled;
            fileInput.disabled = !enabled;
            micBtn.disabled = !enabled;
            chatInput.placeholder = enabled ? placeholder : '–°–º–∞—Ä—Ç–∏ –º–∏—Å–ª–∏...';
        }

        async function handleTextInput() {
            const text = chatInput.value.trim();
            if (text === '' || conversationState.includes('processing')) return;
            addUserMessage(text);
            chatInput.value = '';
            conversationHistory.push({ role: 'user', content: text });

            // UX –ü–û–î–û–ë–†–ï–ù–ò–ï: –°–ø–µ—Ü–∏–∞–ª–µ–Ω —Å–ª—É—á–∞–π –∑–∞ "—Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞"
            if (text.toLowerCase() === '—Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞' && conversationState === 'idle') {
                startSignalFlow(false);
                return;
            }

            switch (conversationState) {
                case 'awaiting_tracking_code':
                    handleSignalCheck(text);
                    break;
                case 'awaiting_manual_description':
                case 'awaiting_address':
                    await processTextForSignalData(text);
                    break;
                case 'awaiting_email':
                    if (isValidEmail(text) || ['–ø—Ä–æ–ø—É—Å–Ω–∏', '–Ω–µ'].includes(text.toLowerCase())) {
                        tempSignalData.email = text.toLowerCase();
                        askForFinalConfirmation(); // UX: –î–∏—Ä–µ–∫—Ç–Ω–æ –∫—ä–º —Ñ–∏–Ω–∞–ª–Ω–æ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ
                    } else {
                        addBotMessage("–¢–æ–≤–∞ –Ω–µ –∏–∑–≥–ª–µ–∂–¥–∞ –∫–∞—Ç–æ –≤–∞–ª–∏–¥–µ–Ω –∏–º–µ–π–ª. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≥–æ –æ—Ç–Ω–æ–≤–æ –∏–ª–∏ –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ –±—É—Ç–æ–Ω–∞ '–ü—Ä–æ–ø—É—Å–Ω–∏'.");
                    }
                    break;
                case 'awaiting_confirmation':
                    addBotMessage("–ú–æ–ª—è, –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –±—É—Ç–æ–Ω–∏—Ç–µ '–ü–æ—Ç–≤—ä—Ä–¥–∏', '–ü—Ä–æ–º–µ–Ω–∏' –∏–ª–∏ '–û—Ç–º–µ–Ω–∏', –∑–∞ –¥–∞ –ø—Ä–æ–¥—ä–ª–∂–∏—Ç–µ.");
                    break;
                default: // idle
                    determineUserIntent(text);
                    break;
            }
        }

        async function determineUserIntent(text) {
            toggleInput(false);
            updateProcessingMessage("–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º...");
            try {
                const intentData = await getIntentFromText(text);
                removeProcessingMessage();

                if (intentData.intent === 'check_status') {
                    handleSignalCheck(intentData.tracking_code);
                } else if (intentData.intent === 'submit_signal') {
                    startSignalFlow(false, text); // –ó–∞–ø–æ—á–≤–∞–º–µ –ø—Ä–æ—Ü–µ—Å–∞ –±–µ–∑ —Å–Ω–∏–º–∫–∞, –Ω–æ —Å –≤–µ—á–µ –ø–æ–¥–∞–¥–µ–Ω —Ç–µ–∫—Å—Ç
                } else {
                    const botResponse = await getConversationalResponse();
                    addBotMessage(botResponse);
                    conversationHistory.push({ role: 'assistant', content: botResponse });
                    toggleInput(true);
                }
            } catch (error) {
                removeProcessingMessage();
                addBotMessage(`–£–ø—Å, –≤—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–∞: ${error.message} üßê`);
                toggleInput(true);
            }
        }

        async function handleSignalCheck(trackingCode) {
            if (!trackingCode) {
                conversationState = 'awaiting_tracking_code';
                addBotMessage("–†–∞–∑–±–∏—Ä–∞ —Å–µ, –º–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ –∫–æ–¥–∞ –∑–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ (–Ω–∞–ø—Ä. SV-XXXXXX).");
                toggleInput(true, "–í—ä–≤–µ–¥–µ—Ç–µ –∫–æ–¥...");
                return;
            }

            toggleInput(false);
            updateProcessingMessage(`–ü—Ä–æ–≤–µ—Ä—è–≤–∞–º —Å—Ç–∞—Ç—É—Å –∑–∞ ${trackingCode}... ‚è≥`);

            try {
                const { data, error } = await getSupabaseClientOrAlert()
                    .from('signal')
                    .select(`description, date_created, institution, status ( description, date_changed )`)
                    .eq('tracking_code', trackingCode.toUpperCase())
                    .single();

                removeProcessingMessage();

                if (error || !data) {
                    addBotMessage(`–ù–µ –Ω–∞–º–∏—Ä–∞–º —Å–∏–≥–Ω–∞–ª —Å –∫–æ–¥ **${trackingCode}**. –ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –≥–æ –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.`);
                } else {
                    const formattedDate = new Date(data.status.date_changed).toLocaleString('bg-BG');
                    let statusMessage = `–ï—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –∑–∞ —Å–∏–≥–Ω–∞–ª **${trackingCode}**:
- **–ü—Ä–æ–±–ª–µ–º:** ${data.description}
- **–ò–Ω—Å—Ç–∏—Ç—É—Ü–∏—è:** **${data.institution}**
- **–ü–æ—Å–ª–µ–¥–µ–Ω —Å—Ç–∞—Ç—É—Å:** "${data.status.description}" –æ—Ç ${formattedDate}`;
                    addBotMessage(statusMessage);
                }
            } catch (e) {
                removeProcessingMessage();
                addBotMessage(`–í—ä–∑–Ω–∏–∫–Ω–∞ –≥—Ä–µ—à–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞—Ç–∞: ${e.message} üò•`);
            } finally {
                conversationState = 'idle';
                toggleInput(true);
            }
        }

        function startSignalFlow(withPhoto, initialText = null) {
            tempSignalData = {};
            conversationHistory = []; // –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∑–∞ –Ω–æ–≤–∏—è —Å–∏–≥–Ω–∞–ª
            if (withPhoto) {
                addBotMessage("–ß—É–¥–µ—Å–Ω–æ! –ú–æ–ª—è, –ø—Ä–∏–∫–∞—á–µ—Ç–µ —Å–Ω–∏–º–∫–∞ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞, –∫–∞—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ –∏–∫–æ–Ω–∞—Ç–∞ —Å –∫–ª–∞–º–µ—Ä/–∫–∞—Ä—Ç–∏–Ω–∫–∞. üñºÔ∏è");
                // UX –ü–û–î–û–ë–†–ï–ù–ò–ï: –ü–æ–¥—Å–∫–∞–∑–∫–∞ –∑–∞ –¥–µ–π—Å—Ç–≤–∏–µ
                fileInputLabel.classList.add('highlight-action');
                setTimeout(() => fileInputLabel.classList.remove('highlight-action'), 3000);
                fileInput.click(); // –î–∏—Ä–µ–∫—Ç–Ω–æ –æ—Ç–≤–∞—Ä—è–º–µ –¥–∏–∞–ª–æ–≥–∞ –∑–∞ –∏–∑–±–æ—Ä –Ω–∞ —Ñ–∞–π–ª
            } else {
                conversationState = 'awaiting_manual_description';
                if (initialText) {
                    processTextForSignalData(initialText);
                } else {
                    addBotMessage("–†–∞–∑–±—Ä–∞–Ω–æ, –∑–∞–ø–æ—á–≤–∞–º–µ —Å–∏–≥–Ω–∞–ª –±–µ–∑ —Å–Ω–∏–º–∫–∞. –ú–æ–ª—è, –æ–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞ —Å –Ω—è–∫–æ–ª–∫–æ –¥—É–º–∏.");
                    toggleInput(true, "–û–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞...");
                }
            }
        }

        async function handleFileSelect(event) {
            fileInputLabel.classList.remove('highlight-action'); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ç–∞
            let originalFile = event.target.files[0];
            if (!originalFile) return;
            event.target.value = '';

            conversationState = 'processing_image';
            toggleInput(false, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞ —Å–Ω–∏–º–∫–∞...');
            updateProcessingMessage('–û–±—Ä–∞–±–æ—Ç–≤–∞–º —Å–Ω–∏–º–∫–∞—Ç–∞... üñºÔ∏è');

            const fileName = originalFile.name.toLowerCase();
            if (fileName.endsWith('.heic') || fileName.endsWith('.heif')) {
                updateProcessingMessage("–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–º HEIC/Live Photo... üîÑ");
                try {
                    originalFile = await handleHeicConversion(originalFile);
                } catch (error) {
                    removeProcessingMessage();
                    addBotMessage(`‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ HEIC: ${error.message}`);
                    toggleInput(true); conversationState = 'idle'; return;
                }
            }

            tempSignalData = { originalFile };
            const imageBase64 = await toBase64(originalFile);
            const mediaContainer = addUserMessage(imageBase64, true);
            tempSignalData.mediaContainer = mediaContainer;

            processLocationAndContinue();
        }

        async function processLocationAndContinue() {
            updateProcessingMessage("üîç –¢—ä—Ä—Å—è GPS –¥–∞–Ω–Ω–∏ –≤ —Å–Ω–∏–º–∫–∞—Ç–∞...");
            const location = await getLocation(tempSignalData.originalFile);

            if (location.address) {
                tempSignalData.latitude = location.latitude;
                tempSignalData.longitude = location.longitude;
                tempSignalData.address = location.address;

                await animateMapInBubble(tempSignalData.mediaContainer, location.latitude, location.longitude);

                removeProcessingMessage();
                addBotMessage(`üìç –û—Ç–∫—Ä–∏—Ö –∞–¥—Ä–µ—Å –æ—Ç —Å–Ω–∏–º–∫–∞—Ç–∞: **${location.address}**`);
                processDescriptionAndContinue();
            } else {
                removeProcessingMessage();
                askForLocationWithButton();
            }
        }

        async function processDescriptionAndContinue() {
            updateProcessingMessage("ü§ñ –ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º –ø—Ä–æ–±–ª–µ–º–∞ –æ—Ç —Å–Ω–∏–º–∫–∞—Ç–∞...");
            try {
                const compressedBase64 = await compressImage(tempSignalData.originalFile);
                const description = await getDescriptionFromImage(compressedBase64);

                if (description.includes("–ù–µ –µ —É—Å—Ç–∞–Ω–æ–≤–µ–Ω–∞") || description.includes("–ù–µ—è—Å–Ω–∞ —Å–Ω–∏–º–∫–∞")) {
                    removeProcessingMessage();
                    addBotMessage(`ü§î ${description}. –ú–æ–ª—è, –æ–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞ —Å –Ω—è–∫–æ–ª–∫–æ –¥—É–º–∏.`);
                    conversationState = 'awaiting_manual_description';
                    toggleInput(true, '–û–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞...');
                    return;
                }
                tempSignalData.description = description;
                removeProcessingMessage();
                addBotMessage(`–†–∞–∑–ø–æ–∑–Ω–∞—Ç –ø—Ä–æ–±–ª–µ–º: "${description}"`);
                processInstitutionAndContinue();
            } catch (error) {
                removeProcessingMessage();
                addBotMessage(`‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞ —Å–Ω–∏–º–∫–∞: ${error.message}`);
                conversationState = 'idle';
                toggleInput(true);
            }
        }

        async function processInstitutionAndContinue() {
            updateProcessingMessage("üèõÔ∏è –û–ø—Ä–µ–¥–µ–ª—è–º –æ—Ç–≥–æ–≤–æ—Ä–Ω–∞ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è...");
            try {
                tempSignalData.institution = await getInstitution(tempSignalData.description);
                removeProcessingMessage();
                addBotMessage(`–°–∏–≥–Ω–∞–ª—ä—Ç —â–µ –±—ä–¥–µ –Ω–∞—Å–æ—á–µ–Ω –∫—ä–º: **${tempSignalData.institution}**`);
            } catch (error) {
                removeProcessingMessage();
                addBotMessage(`‚ùå –ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è: ${error.message}`);
                tempSignalData.institution = "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞";
            }

            askForEmail(); // UX: –î–∏—Ä–µ–∫—Ç–Ω–æ –ø–∏—Ç–∞–º–µ –∑–∞ –∏–º–µ–π–ª
        }

        async function processTextForSignalData(text) {
            toggleInput(false);
            updateProcessingMessage("–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞... üìù");

            try {
                const extractedData = await extractSignalDataFromText(text);
                if (extractedData.description) tempSignalData.description = extractedData.description;
                if (extractedData.address) tempSignalData.address = extractedData.address;
                removeProcessingMessage();

                if (!tempSignalData.description) {
                    conversationState = 'awaiting_manual_description';
                    addBotMessage("–î–æ–±—Ä–µ, –Ω–æ –∫–∞–∫–≤–æ –µ –æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞?");
                    toggleInput(true, "–û–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞...");
                } else if (!tempSignalData.address) {
                    conversationState = 'awaiting_address';
                    askForLocationWithButton();
                } else {
                    processInstitutionAndContinue();
                }
            } catch (error) {
                removeProcessingMessage();
                addBotMessage(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ —Ç–µ–∫—Å—Ç–∞: ${error.message}`);
                toggleInput(true);
            }
        }

        function askForLocationWithButton() {
            const message = `–ü—Ä–∏–µ—Ö –æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ. –°–µ–≥–∞ –º–∏ –µ –Ω—É–∂–µ–Ω –∞–¥—Ä–µ—Å. –ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≥–æ, –∏–ª–∏ –∞–∫–æ —Å—Ç–µ –Ω–∞ –º—è—Å—Ç–æ—Ç–æ, –Ω–∞—Ç–∏—Å–Ω–µ—Ç–µ –±—É—Ç–æ–Ω–∞.
<br><button id="detect-location-btn" class="location-button">üìç –ó–∞—Å–µ—á–∏ –º–æ—è—Ç–∞ –ª–æ–∫–∞—Ü–∏—è</button>`;
            addBotMessage(message, true);
            conversationState = 'awaiting_address';
            toggleInput(true, '–í—ä–≤–µ–¥–µ—Ç–µ –∞–¥—Ä–µ—Å...');
        }

        // UX –ü–û–î–û–ë–†–ï–ù–ò–ï: –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∏—Ä–∞–Ω handler –∑–∞ –±—É—Ç–æ–Ω–∏
        async function handleChatButtonClick(event) {
            const target = event.target;

            // –ë—ä—Ä–∑–∏ –æ—Ç–≥–æ–≤–æ—Ä–∏
            if (target.matches('.quick-reply-btn')) {
                const action = target.dataset.action;
                target.parentElement.remove(); // –ü—Ä–µ–º–∞—Ö–≤–∞–º–µ –±—É—Ç–æ–Ω–∏—Ç–µ —Å–ª–µ–¥ –∏–∑–±–æ—Ä
                addUserMessage(target.textContent); // –ü–æ–∫–∞–∑–≤–∞–º–µ –∏–∑–±–æ—Ä–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è

                if (action === 'start_signal_photo') {
                    startSignalFlow(true);
                } else if (action === 'start_signal_no_photo') {
                    startSignalFlow(false);
                } else if (action === 'check_status') {
                    handleSignalCheck(null);
                }
                return;
            }

            // –î—Ä—É–≥–∏ –±—É—Ç–æ–Ω–∏
            if (target.id === 'detect-location-btn') handleLocationButtonClick(target);
            else if (target.id === 'skip-email-btn') handleSkipEmailClick(target);
            else if (target.id === 'confirm-btn') {
                target.closest('.button-container').innerHTML = '–ü–æ—Ç–≤—ä—Ä–¥–µ–Ω–æ.';
                addUserMessage("–ü–æ—Ç–≤—ä—Ä–¥–∏");
                finalSubmit();
            } else if (target.id === 'cancel-btn') {
                target.closest('.button-container').innerHTML = '–û—Ç–º–µ–Ω–µ–Ω–æ.';
                addUserMessage("–û—Ç–º–µ–Ω–∏");
                addBotMessage("–†–∞–∑–±—Ä–∞–Ω–æ. –°–∏–≥–Ω–∞–ª—ä—Ç –µ –æ—Ç–º–µ–Ω–µ–Ω. –ú–æ–∂–µ –¥–∞ –∑–∞–ø–æ—á–Ω–µ—Ç–µ –æ—Ç–Ω–∞—á–∞–ª–æ, –∞–∫–æ –∂–µ–ª–∞–µ—Ç–µ.");
                conversationState = 'idle';
                toggleInput(true);
            } else if (target.id === 'edit-desc-btn' || target.id === 'edit-addr-btn') {
                const isDesc = target.id === 'edit-desc-btn';
                target.closest('.button-container').innerHTML = `–î–æ–±—Ä–µ, –ø—Ä–æ–º–µ–Ω—è–º ${isDesc ? '–æ–ø–∏—Å–∞–Ω–∏–µ—Ç–æ' : '–∞–¥—Ä–µ—Å–∞'}.`;
                if (isDesc) {
                    conversationState = 'awaiting_manual_description';
                    addBotMessage("–ú–æ–ª—è, –Ω–∞–ø–∏—à–µ—Ç–µ –Ω–æ–≤–æ—Ç–æ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞.");
                    toggleInput(true, "–í—ä–≤–µ–¥–µ—Ç–µ –Ω–æ–≤–æ –æ–ø–∏—Å–∞–Ω–∏–µ...");
                } else {
                    conversationState = 'awaiting_address';
                    askForLocationWithButton();
                }
            }
        }

        function handleSkipEmailClick(button) {
            button.parentElement.innerHTML = '–ò–º–µ–π–ª—ä—Ç –µ –ø—Ä–æ–ø—É—Å–Ω–∞—Ç.';
            addUserMessage("–ü—Ä–æ–ø—É—Å–Ω–∏");
            tempSignalData.email = '–ø—Ä–æ–ø—É—Å–Ω–∏';
            askForFinalConfirmation();
        }

        async function handleLocationButtonClick(button) {
            button.textContent = '–ó–∞—Å–∏—á–∞–Ω–µ...';
            button.disabled = true;
            toggleInput(false);

            const navLocation = await getNavigatorLocation();
            if (navLocation) {
                const address = await getAddressFromOpenCage(navLocation.latitude, navLocation.longitude);
                tempSignalData.latitude = navLocation.latitude;
                tempSignalData.longitude = navLocation.longitude;
                tempSignalData.address = address;
                addUserMessage(`üìç –ò–∑–ø–æ–ª–∑–≤–∞–º –Ω–∞—Å—Ç–æ—è—â–∞—Ç–∞ –ª–æ–∫–∞—Ü–∏—è: ${address}`);

                if (tempSignalData.originalFile && !tempSignalData.description) {
                    processDescriptionAndContinue();
                } else {
                    processInstitutionAndContinue();
                }
            } else {
                addBotMessage("–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Å–∏—á–∞–Ω–µ –Ω–∞ –ª–æ–∫–∞—Ü–∏—è. –ú–æ–ª—è, —Ä–∞–∑—Ä–µ—à–µ—Ç–µ –¥–æ—Å—Ç—ä–ø –∏ –æ–ø–∏—Ç–∞–π—Ç–µ –ø–∞–∫, –∏–ª–∏ –≤—ä–≤–µ–¥–µ—Ç–µ –∞–¥—Ä–µ—Å–∞ —Ä—ä—á–Ω–æ.");
                button.textContent = 'üìç –û–ø–∏—Ç–∞–π –ø–∞–∫';
                button.disabled = false;
                toggleInput(true, '–í—ä–≤–µ–¥–µ—Ç–µ –∞–¥—Ä–µ—Å...');
            }
        }

        // UX –ü–û–î–û–ë–†–ï–ù–ò–ï: –ù–æ–≤–∞ —Å—Ç—ä–ø–∫–∞, –∫–æ—è—Ç–æ –ø–∏—Ç–∞ –∑–∞ –∏–º–µ–π–ª
        function askForEmail() {
            const message = `–ü–æ—á—Ç–∏ —Å–º–µ –≥–æ—Ç–æ–≤–∏! –ê–∫–æ –∂–µ–ª–∞–µ—Ç–µ –¥–∞ –ø–æ–ª—É—á–∞–≤–∞—Ç–µ –∏–∑–≤–µ—Å—Ç–∏—è –∑–∞ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Å–∏–≥–Ω–∞–ª–∞, –º–æ–ª—è –≤—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ–π–ª –∞–¥—Ä–µ—Å.
<div class="button-container"><button id="skip-email-btn" class="location-button skip-button">–ü—Ä–æ–ø—É—Å–Ω–∏</button></div>`;
            addBotMessage(message, true);
            conversationState = 'awaiting_email';
            toggleInput(true, '–í—ä–≤–µ–¥–µ—Ç–µ –∏–º–µ–π–ª...');
        }

        // UX –ü–û–î–û–ë–†–ï–ù–ò–ï: –û–±–µ–¥–∏–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –∑–∞ —Ñ–∏–Ω–∞–ª–Ω–æ –ø–æ—Ç–≤—ä—Ä–∂–¥–µ–Ω–∏–µ
        function askForFinalConfirmation() {
            let summary = `**–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ —Å–∏–≥–Ω–∞–ª–∞:**
- **–ü—Ä–æ–±–ª–µ–º:** ${tempSignalData.description}
- **–ê–¥—Ä–µ—Å:** ${tempSignalData.address}
- **–ò–Ω—Å—Ç–∏—Ç—É—Ü–∏—è:** **${tempSignalData.institution}**`;

            if (tempSignalData.email && !['–ø—Ä–æ–ø—É—Å–Ω–∏', '–Ω–µ'].includes(tempSignalData.email)) {
                summary += `\n- **–ò–º–µ–π–ª –∑–∞ –≤—Ä—ä–∑–∫–∞:** ${tempSignalData.email}`;
            } else {
                summary += `\n- **–ò–º–µ–π–ª –∑–∞ –≤—Ä—ä–∑–∫–∞:** –ù–µ –µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–µ–Ω`;
            }
            summary += "\n\n–í—Å–∏—á–∫–æ —Ç–æ—á–Ω–æ –ª–∏ –µ? –ú–æ–ª—è, –ø–æ—Ç–≤—ä—Ä–¥–µ—Ç–µ, –∑–∞ –¥–∞ –∏–∑–ø—Ä–∞—Ç–∏–º —Å–∏–≥–Ω–∞–ª–∞.";

            const buttonsHTML = `
    <div class="button-container">
        <button id="confirm-btn" class="location-button confirm-button">‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–∏ –∏ –∏–∑–ø—Ä–∞—Ç–∏</button>
        <button id="edit-desc-btn" class="location-button edit-button">‚úèÔ∏è –ü—Ä–æ–º–µ–Ω–∏ –æ–ø–∏—Å–∞–Ω–∏–µ</button>
        <button id="edit-addr-btn" class="location-button edit-button">üìç –ü—Ä–æ–º–µ–Ω–∏ –∞–¥—Ä–µ—Å</button>
        <button id="cancel-btn" class="location-button cancel-button">‚ùå –û—Ç–º–µ–Ω–∏</button>
    </div>`;

            addBotMessage(summary + buttonsHTML, true);
            conversationState = 'awaiting_confirmation';
            toggleInput(false, '–ú–æ–ª—è, –∏–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ –±—É—Ç–æ–Ω–∏—Ç–µ...');
        }


        async function finalSubmit() {
            conversationState = 'processing_final';
            toggleInput(false, '–ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª–∞...');

            await playNewSubmissionAnimation(tempSignalData);

            try {
                const trackCode = 'SV-' + Math.random().toString(36).substring(2, 8).toUpperCase();
                tempSignalData.trackCode = trackCode;

                if (tempSignalData.originalFile) {
                    const imageUrl = await uploadImageToSupabase(tempSignalData.originalFile, trackCode);
                    tempSignalData.imageUrl = imageUrl;
                }

                await submitSignalToSupabase(tempSignalData);
                addBotMessage(`‚úÖ –ì–æ—Ç–æ–≤–æ! –í–∞—à–∏—è—Ç —Å–∏–≥–Ω–∞–ª –µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω —Å –∫–æ–¥ –∑–∞ –ø—Ä–æ—Å–ª–µ–¥—è–≤–∞–Ω–µ: **${trackCode}**. –ë–ª–∞–≥–æ–¥–∞—Ä–∏–º –í–∏ –∑–∞ –∞–∫—Ç–∏–≤–Ω–∞—Ç–∞ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∞ –ø–æ–∑–∏—Ü–∏—è! üöÄ`);

            } catch (error) {
                addBotMessage(`‚ùå –û—Ö, –Ω–µ—â–æ —Å–µ –æ–±—ä—Ä–∫–∞ –ø—Ä–∏ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–µ –Ω–∞ —Å–∏–≥–Ω–∞–ª–∞: ${error.message}. –ú–æ–ª—è, –æ–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.`);
            } finally {
                conversationState = 'idle';
                toggleInput(true);
            }
        }

        async function playNewSubmissionAnimation(data) {
            return new Promise(async (resolve) => {
                const photoSrc = data.originalFile ? URL.createObjectURL(data.originalFile) : '';
                const hasLocation = data.latitude && data.longitude;

                const animationHTML = `
            <div class="card-flipper">
                <div class="card-inner">
                    <div class="card-face card-face-front">
                        <p class="card-description">${data.description}</p>
                        <div class="card-media-container">
                            ${photoSrc ? `<img src="${photoSrc}" class="card-photo" alt="–°–Ω–∏–º–∫–∞ –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞">` : ''}
                            <div class="card-map"></div>
                        </div>
                    </div>
                    <div class="card-face card-face-back">
                        <img src="inst.png" class="card-institution-icon" onerror="this.style.display='none'">
                        <p class="card-institution-name">${data.institution}</p>
                    </div>
                </div>
            </div>
        `;

                const overlay = document.createElement('div');
                overlay.className = 'signal-card-overlay';
                overlay.innerHTML = animationHTML;
                document.body.appendChild(overlay);

                const cardInner = overlay.querySelector('.card-inner');
                const photoEl = overlay.querySelector('.card-photo');
                const mapEl = overlay.querySelector('.card-map');
                const delay = ms => new Promise(res => setTimeout(res, ms));

                await delay(50);
                overlay.classList.add('visible');
                await delay(300);

                if (hasLocation) {
                    if (photoEl) photoEl.classList.add('fade-out');
                    mapEl.classList.add('fade-in');
                    const map = L.map(mapEl, { zoomControl: false, scrollWheelZoom: false, dragging: false, attributionControl: false }).setView([data.latitude, data.longitude], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                    await delay(100);
                    map.invalidateSize();
                    map.flyTo([data.latitude, data.longitude], 17, { duration: 2 });
                    await delay(1600);
                    L.marker([data.latitude, data.longitude]).addTo(map);
                    await delay(1400);
                } else {
                    await delay(3000);
                }

                cardInner.classList.add('is-flipped');
                await delay(2000);
                overlay.classList.remove('visible');
                await delay(500);
                overlay.remove();
                resolve();
            });
        }

        async function animateMapInBubble(mediaContainer, lat, lng) {
            return new Promise(resolve => {
                const photoElement = mediaContainer.querySelector('.uploaded-photo');
                if (!photoElement) { resolve(); return; }

                const mapDiv = document.createElement('div');
                mapDiv.className = 'map-inline';
                mediaContainer.appendChild(mapDiv);

                const map = L.map(mapDiv, { zoomControl: false, scrollWheelZoom: false, dragging: false, attributionControl: false }).setView([lat, lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

                photoElement.classList.add('fade-out');
                mapDiv.classList.add('fade-in');

                setTimeout(() => {
                    map.invalidateSize();
                    map.flyTo([lat, lng], 17, { duration: 2 });
                }, 100);

                setTimeout(() => { L.marker([lat, lng]).addTo(map); }, 1600);

                setTimeout(() => {
                    mapDiv.classList.remove('fade-in');
                    mapDiv.classList.add('fade-out');
                    photoElement.classList.remove('fade-out');

                    setTimeout(() => {
                        mediaContainer.removeChild(mapDiv);
                        resolve();
                    }, 500);
                }, 4000);
            });
        }

        async function uploadImageToSupabase(file, trackCode) {
            const filePath = `photo_${trackCode}_${file.name}`;
            const { data: uploadData, error: uploadError } = await getSupabaseClientOrAlert().storage.from('signal-photos').upload(filePath, file);
            if (uploadError) throw new Error(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∫–∞—á–≤–∞–Ω–µ –Ω–∞ —Å–Ω–∏–º–∫–∞: ${uploadError.message}`);
            const { data: urlData } = getSupabaseClientOrAlert().storage.from('signal-photos').getPublicUrl(uploadData.path);
            return urlData.publicUrl;
        }

        async function submitSignalToSupabase(data) {
            let citizenId = null;
            if (data.email && !['–ø—Ä–æ–ø—É—Å–Ω–∏', '–Ω–µ'].includes(data.email)) {
                const { data: existingCitizen } = await getSupabaseClientOrAlert().from('citizens').select('citizen_id, total_signals').eq('email', data.email).single();
                if (existingCitizen) {
                    await getSupabaseClientOrAlert().from('citizens').update({ total_signals: existingCitizen.total_signals + 1 }).eq('citizen_id', existingCitizen.citizen_id);
                    citizenId = existingCitizen.citizen_id;
                } else {
                    const { data: newCitizen, error: createError } = await getSupabaseClientOrAlert().from('citizens').insert({ email: data.email, total_signals: 1, registration_date: getFormattedDateTime() }).select('citizen_id').single();
                    if (createError) throw createError;
                    citizenId = newCitizen.citizen_id;
                }
            } else {
                const { data: anonCitizen, error: anonError } = await getSupabaseClientOrAlert().from('citizens').insert({}).select('citizen_id').single();
                if (anonError) throw anonError;
                citizenId = anonCitizen.citizen_id;
            }

            const { data: statusData, error: statusError } = await getSupabaseClientOrAlert().from('status').insert({
                description: "–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª",
                date_changed: getFormattedDateTime(),
                tracking_code: data.trackCode,
                status_type_id: '98e5cc79-e763-4e41-b1c2-b0303aa8f759'
            }).select('status_id').single();
            if (statusError) throw statusError;

            const { error: signalError } = await getSupabaseClientOrAlert().from('signal').insert({
                description: data.description,
                adress: data.address,
                image_url: data.imageUrl || null,
                date_created: getFormattedDateTime(),
                tracking_code: data.trackCode,
                citizen_id: citizenId,
                status_id: statusData.status_id,
                institution: data.institution,
                latitude: data.latitude || null,
                longitude: data.longitude || null
            });
            if (signalError) throw signalError;
        }

        async function handleHeicConversion(heicFile) {
            if (typeof libheif === 'undefined') {
                throw new Error("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ç–∞ –∑–∞ HEIC –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–µ –µ –∑–∞—Ä–µ–¥–µ–Ω–∞. –ú–æ–ª—è, –ø—Ä–æ–≤–µ—Ä–µ—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –≤—Ä—ä–∑–∫–∞—Ç–∞ —Å–∏ –∏ –ø—Ä–µ–∑–∞—Ä–µ–¥–µ—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ç–∞.");
            }
            const arrayBuffer = await heicFile.arrayBuffer();
            const decoder = new libheif.HeifDecoder();
            const images = decoder.decode(arrayBuffer);
            if (!images || images.length === 0) throw new Error('–§–∞–π–ª—ä—Ç –Ω–µ —Å—ä–¥—ä—Ä–∂–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');

            const firstImage = images[0];
            const width = firstImage.get_width(); const height = firstImage.get_height();

            const imageData = await new Promise((resolve, reject) => {
                firstImage.get_image_data(width, height, (data) => data ? resolve(data) : reject(new Error('–ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∫–∞–¥—ä—Ä.')));
            });

            const canvas = document.createElement('canvas');
            canvas.width = width; canvas.height = height;
            canvas.getContext('2d').putImageData(imageData, 0, 0);

            return new Promise(resolve => canvas.toBlob(blob => {
                resolve(new File([blob], "converted.jpeg", { type: "image/jpeg" }));
            }, 'image/jpeg', 0.9));
        }

        function getFormattedDateTime() { return new Date().toISOString().slice(0, 19).replace('T', ' '); }

        async function getLocation(file) {
            const exif = await getExifLocation(file);
            if (exif && exif.latitude && exif.longitude) {
                const address = await getAddressFromOpenCage(exif.latitude, exif.longitude);
                return { ...exif, address };
            }
            return { error: "–ù—è–º–∞ EXIF –¥–∞–Ω–Ω–∏." };
        }
        function getExifLocation(file) { return new Promise(r => EXIF.getData(file, function () { const la = EXIF.getTag(this, "GPSLatitude"), lo = EXIF.getTag(this, "GPSLongitude"), laR = EXIF.getTag(this, "GPSLatitudeRef"), loR = EXIF.getTag(this, "GPSLongitudeRef"); const dmsToDd = (d, dir) => { if (!d) return null; let dd = d[0] + d[1] / 60 + d[2] / 3600; if (dir === "S" || dir === "W") dd *= -1; return dd; }; if (la && lo) r({ latitude: dmsToDd(la, laR), longitude: dmsToDd(lo, loR) }); else r(null) })); }
        function getNavigatorLocation() { return new Promise(r => !navigator.geolocation ? r(null) : navigator.geolocation.getCurrentPosition(p => r({ latitude: p.coords.latitude, longitude: p.coords.longitude }), () => r(null), { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 })) }
        async function getAddressFromOpenCage(lat, lng) {
            const apiUrl = `/api/get-address?lat=${lat}&lng=${lng}`;
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data && data.results && data.results.length > 0 && data.results[0].formatted) {
                    return data.results[0].formatted;
                }
                return `–ê–¥—Ä–µ—Å –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω –∑–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏.`;
            } catch (error) { console.error('OpenCage Error:', error); return "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∞–¥—Ä–µ—Å."; }
        }
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
        function compressImage(file, maxWidth = 1024, quality = 0.8) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onerror = error => reject(error);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onerror = error => reject(error);
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > maxWidth) { height = (maxWidth / width) * height; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
            });
        }

        // –ó–ê–ú–Ø–ù–ê: –ê–Ω–∞–ª–∏–∑ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á—Ä–µ–∑ –±–µ–∫–µ–Ω–¥–∞
        async function getDescriptionFromImage(base64Image) {
            const headers = { "Content-Type": "application/json" };
            const payload = { base64Image, systemPrompt: OPENAI_VISION_SYSTEM_PROMPT };
            try {
                const response = await fetch("/api/analyze-image", { method: "POST", headers, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
                const data = await response.json();
                if (data && data.description) return data.description;
                return "–ù–µ—è—Å–Ω–∞ —Å–Ω–∏–º–∫–∞, –º–æ–ª—è –æ–ø–∏—à–µ—Ç–µ –ø—Ä–æ–±–ª–µ–º–∞";
            } catch (error) {
                return `–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑: ${error.message}`;
            }
        }
        // –ó–ê–ú–Ø–ù–ê: –û–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è —á—Ä–µ–∑ –±–µ–∫–µ–Ω–¥–∞
        async function getInstitution(description) {
            const headers = { "Content-Type": "application/json" };
            const payload = { description, systemPrompt: OPENAI_INSTITUTION_PROMPT };
            try {
                const response = await fetch("/api/get-institution", { method: "POST", headers, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª—è–Ω–µ –Ω–∞ –∏–Ω—Å—Ç–∏—Ç—É—Ü–∏—è");
                const data = await response.json();
                if (data && data.institution) return data.institution.trim();
                return "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞";
            } catch (error) {
                return "–û–±—â–∏–Ω–∞ –í–∞—Ä–Ω–∞";
            }
        }
        // –ó–ê–ú–Ø–ù–ê: Intent extraction —á—Ä–µ–∑ –±–µ–∫–µ–Ω–¥–∞ (—Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ —Ç–∞–∫—ä–≤ endpoint)
        async function getIntentFromText(text) {
            const headers = { "Content-Type": "application/json" };
            const payload = { text, systemPrompt: OPENAI_INTENT_PROMPT };
            try {
                const response = await fetch("/api/get-intent", { method: "POST", headers, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏–µ");
                const data = await response.json();
                return data;
            } catch (error) {
                return { intent: "general_chat", tracking_code: null };
            }
        }
        // –ó–ê–ú–Ø–ù–ê: Extraction –Ω–∞ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ –∞–¥—Ä–µ—Å —á—Ä–µ–∑ –±–µ–∫–µ–Ω–¥–∞ (—Ç—Ä—è–±–≤–∞ –¥–∞ –∏–º–∞ —Ç–∞–∫—ä–≤ endpoint)
        async function extractSignalDataFromText(text) {
            const headers = { "Content-Type": "application/json" };
            const payload = { text, systemPrompt: OPENAI_EXTRACTION_PROMPT };
            try {
                const response = await fetch("/api/get-extract", { method: "POST", headers, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏");
                const data = await response.json();
                return data;
            } catch (error) {
                return { description: text, address: null };
            }
        }
        function isValidEmail(email) {
            const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.lang = 'bg-BG';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                recognition.onstart = () => { micBtn.classList.add('listening'); };
                recognition.onend = () => { micBtn.classList.remove('listening'); };
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    chatInput.value = transcript;
                    handleTextInput();
                };
                recognition.onerror = (event) => { addBotMessage(`–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–ª–∞—Å–æ–≤–æ—Ç–æ —Ä–∞–∑–ø–æ–∑–Ω–∞–≤–∞–Ω–µ: ${event.error}`); };
            } else {
                micBtn.style.display = 'none';
            }
        }
        function toggleSpeechRecognition() {
            if (micBtn.classList.contains('listening')) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        // --- Supabase secure initialization ---
        function getSupabaseClientOrAlert() {
            if (!window.supabaseClient) {
                alert('Supabase –∫–ª–∏–µ–Ω—Ç—ä—Ç –Ω–µ –µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω! –ü—Ä–æ–≤–µ—Ä–∏ –∫–ª—é—á–æ–≤–µ—Ç–µ.');
                throw new Error('Supabase –∫–ª–∏–µ–Ω—Ç—ä—Ç –Ω–µ –µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω!');
            }
            return window.supabaseClient;
        }
        async function loadSupabaseKeys() {
            try {
                const response = await fetch('/api/supabase-keys');
                if (!response.ok) throw new Error('–ù–µ—É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ Supabase –∫–ª—é—á–æ–≤–µ');
                const data = await response.json();
                if (!data.url || !data.anonKey) throw new Error('–õ–∏–ø—Å–≤–∞—Ç Supabase –∫–ª—é—á–æ–≤–µ –∏–ª–∏ URL!');
                window.supabaseClient = supabase.createClient(data.url, data.anonKey);
            } catch (error) {
                alert('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ Supabase –∫–ª—é—á–æ–≤–µ: ' + error.message);
                console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ Supabase –∫–ª—é—á–æ–≤–µ:', error);
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            loadSupabaseKeys();
        });

    </script>
</body>

</html>